# 单细胞RNA-seq数据分析：选择偏倚研究

## 📋 项目概述

本项目通过单细胞RNA-seq数据分析，系统评估不同研究间"健康对照"样本的异质性，揭示选择偏倚的存在。

分析包括三个层面的假设检验：
- **H1: 组成偏倚** - 细胞类型组成是否在研究间存在差异
- **H2: 状态偏倚** - 同一细胞类型内，研究来源是否解释显著方差
- **H3: 网络偏倚** - 基因共表达网络是否在研究间保守

## 📁 项目结构

```
1a-sc入院率偏倚/
│
├── 核心分析脚本
│   ├── main_analysis.py              # 主分析流程（完整分析）
│   └── run_final.py                  # 快速分析（仅H3+差异分析）
│
├── 工具模块
│   ├── config.py                     # 配置参数
│   ├── utils_data_loading.py        # 数据加载
│   ├── utils_preprocessing.py       # 预处理和质控
│   ├── utils_annotation.py          # 细胞类型注释
│   ├── utils_hypothesis_testing.py  # H1和H2假设检验
│   ├── utils_wgcna.py               # WGCNA核心算法
│   ├── utils_network_analysis_improved.py  # H3网络分析
│   └── utils_result_tables.py       # 结果表格生成
│
├── 数据目录
│   └── GSE159354/                   # 原始数据（.h5文件）
│
└── 输出目录（运行后生成）
    ├── data/                        # 处理后的数据
    ├── figures/                     # 图表
    └── results/                     # 结果文件和表格
```

## 🚀 快速开始

### 1. 环境要求

```bash
Python 3.13
R 4.2.2

# Python包
scanpy
pandas
numpy
scipy
scikit-learn
matplotlib
seaborn
harmonypy
statsmodels
```

### 2. 运行完整分析

```bash
python main_analysis.py
```

**分析流程：**
1. 数据加载和质控
2. 批次效应校正（Harmony）
3. 聚类和细胞类型注释
4. H1: 组成偏倚分析
5. H2: 状态偏倚分析
6. H3: 网络偏倚分析（WGCNA）
7. Normal-Normal差异表达分析
8. 生成整合结果表格

**预计运行时间：** 2-4小时（取决于数据量）

### 3. 快速分析（仅H3和差异分析）

如果已经完成了前期分析，可以使用：

```bash
python run_final.py
```

## 📊 输出结果说明

### 结果表格（重点！）

所有关键结果已整理成规范的CSV表格，可直接用于论文：

#### H1 组成偏倚
- `Table_H1_Overall_Statistics.csv` - 总体统计（卡方检验、JS散度）
- `Table_H1_CellType_Details.csv` - 各细胞类型的详细统计

#### H2 状态偏倚
- `Table_H2_State_Bias.csv` - 各细胞类型的状态偏倚分析结果

#### H3 网络偏倚
- `Table_H3_Network_Bias.csv` - 各细胞类型的WGCNA模块保守性

#### 差异表达分析
- `Table_DE_Overall_Statistics.csv` - 总体统计
- `Table_DE_CellType_Details.csv` - 各细胞类型的差异基因统计

### 图表文件

所有图表保存在 `results/figures/` 目录：

- `H1_*.png` - 组成偏倚可视化（堆叠柱状图、热图、箱线图）
- `H2_*.png` - 状态偏倚可视化（PCA图、方差分解图）
- `H3_*.png` - 网络偏倚可视化（模块保守性分布、汇总图）
- `DE_*.png` - 差异表达可视化（柱状图、热图、箱线图）

### 文本报告

- `analysis_report.txt` - 综合分析报告（简化版，详细数据见表格）

## 🔬 方法学说明

### H1: 组成偏倚分析
- **卡方检验** - 检验细胞类型分布是否独立于数据集
- **Jensen-Shannon散度** - 量化数据集间组成差异
- **Kruskal-Wallis检验** - 各细胞类型的跨数据集差异

### H2: 状态偏倚分析
- **PCA降维** - 提取细胞状态的主要变异
- **PERMANOVA** - 检验数据集来源对细胞状态的影响
- **方差分解** - 计算数据集解释的方差比例（R²）

### H3: 网络偏倚分析（WGCNA）
- **软阈值选择** - 使网络符合无标度拓扑
- **拓扑重叠矩阵（TOM）** - 基于共享邻居的相似性
- **模块识别** - 动态树切割识别基因模块
- **模块保守性** - 比较不同数据集间的模块结构

### 差异表达分析
- **Wilcoxon秩和检验** - 非参数检验
- **FDR校正** - Benjamini-Hochberg方法
- **阈值** - FDR < 0.05, |log2FC| > 0.5

## 📈 结果解读指南

### H1 组成偏倚

**关键指标：**
- 卡方检验 p < 0.05 → 存在显著组成差异
- JS散度 > 0.3 → 组成差异较大

**解读：**
- 如果显著，说明不同研究的"正常对照"在细胞组成上就不同
- 简单合并会将取样偏倚固化为"正常基线"

### H2 状态偏倚

**关键指标：**
- R² > 10% → 数据集来源解释了大量方差
- PERMANOVA p < 0.05 → 数据集效应显著

**解读：**
- R²越高，说明同一细胞类型内，不同研究的细胞状态差异越大
- 批次整合无法消除这种内在的生物学异质性

### H3 网络偏倚

**关键指标：**
- 模块保守性 < 0.5 → 高网络偏倚
- 模块保守性 0.5-0.7 → 中等网络偏倚
- 模块保守性 > 0.7 → 低网络偏倚

**解读：**
- 保守性低说明基因调控网络在不同研究间存在系统性差异
- 提示不同研究的"正常"可能代表不同的生物学状态

### 差异表达分析

**关键指标：**
- 平均差异基因数 > 200 → 高异质性
- 平均差异基因数 100-200 → 中等异质性
- 平均差异基因数 < 100 → 低异质性

**解读：**
- 对照组之间的差异基因数反映了研究间的可重复性
- 差异越大，说明"健康对照"的定义越不一致

## 📝 论文写作建议

### 结果部分

建议按以下结构组织：

1. **数据概览**
   - 引用 `analysis_report.txt` 中的数据统计

2. **H1结果**
   - 主文：报告卡方检验和JS散度范围
   - 补充材料：`Table_H1_*.csv`
   - 图表：选择1-2个最有代表性的图

3. **H2结果**
   - 主文：报告平均R²和显著细胞类型数
   - 补充材料：`Table_H2_State_Bias.csv`
   - 图表：选择免疫细胞的PCA图

4. **H3结果**
   - 主文：报告平均模块保守性和偏倚程度分布
   - 补充材料：`Table_H3_Network_Bias.csv`
   - 图表：汇总图展示所有细胞类型

5. **差异表达结果**
   - 主文：报告差异基因数范围和异质性最高的细胞类型
   - 补充材料：`Table_DE_*.csv`

### 方法部分

可以直接引用本README中的"方法学说明"部分，并补充具体参数。

## ⚠️ 注意事项

1. **数据路径**：确保 `config.py` 中的路径设置正确
2. **内存需求**：建议至少32GB RAM
3. **计算时间**：WGCNA分析较耗时，可以先用小数据集测试
4. **结果验证**：建议检查 `analysis_report.txt` 确认分析完成

## 🆘 常见问题

**Q: 运行时内存不足怎么办？**
A: 在 `config.py` 中减少 `n_hvgs` 参数（如从2000降到500）

**Q: WGCNA分析失败？**
A: 检查每个细胞类型的细胞数是否足够（建议≥100）

**Q: 如何修改显著性阈值？**
A: 在对应的工具函数中修改（如 `utils_network_analysis_improved.py`）

**Q: 表格文件乱码？**
A: 使用Excel打开时选择UTF-8编码，或用pandas读取

## 📧 联系方式

如有问题，请检查代码注释或查看各模块的文档字符串。

---

**最后更新：** 2026-01-21
**版本：** 2.0（整合表格版）
