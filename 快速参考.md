# 📋 快速参考卡片

## 🚀 一键运行

```bash
# 完整分析（首次运行）
python main_analysis.py

# 快速分析（仅H3+DE）
python run_final.py
```

## 📊 关键输出表格（用于论文）

| 表格文件 | 内容 | 用途 |
|---------|------|------|
| `Table_H1_Overall_Statistics.csv` | H1总体统计 | 主文数据 |
| `Table_H1_CellType_Details.csv` | 各细胞类型组成差异 | 补充材料 |
| `Table_H2_State_Bias.csv` | 各细胞类型状态偏倚 | 补充材料 |
| `Table_H3_Network_Bias.csv` | 各细胞类型网络偏倚 | 补充材料 |
| `Table_DE_Overall_Statistics.csv` | 差异分析总体统计 | 主文数据 |
| `Table_DE_CellType_Details.csv` | 各细胞类型差异基因 | 补充材料 |

## 📈 结果解读速查

### H1 组成偏倚
- ✅ **显著**: χ² p < 0.05, JS散度 > 0.3
- 📌 **含义**: 不同研究的细胞组成不同

### H2 状态偏倚
- ✅ **显著**: R² > 10%, PERMANOVA p < 0.05
- 📌 **含义**: 同一细胞类型内，研究来源解释大量方差

### H3 网络偏倚
- 🔴 **高偏倚**: 保守性 < 0.5
- 🟡 **中等偏倚**: 保守性 0.5-0.7
- 🟢 **低偏倚**: 保守性 > 0.7
- 📌 **含义**: 基因调控网络在研究间的相似程度

### 差异表达
- 🔴 **高异质性**: 平均DEGs > 200
- 🟡 **中等异质性**: 平均DEGs 100-200
- 🟢 **低异质性**: 平均DEGs < 100
- 📌 **含义**: 对照组之间的差异程度

## 📝 论文写作模板

### 摘要（参考）
```
我们分析了五项独立研究中的28个肺部对照样本，在组成、状态和网络
三个层面评估其可比性。结果显示：细胞类型组成存在显著差异
（χ²检验p < 0.001，Jensen-Shannon散度0.342-0.587）；数据集来源
可解释5%-14%的细胞状态变异（PERMANOVA，p < 0.05）；基因共表达
网络保守性低（<0.4）；对照组间差异基因达125-9952个（FDR < 0.05）。
这些发现表明，不同研究的"健康对照"因纳入标准和人群特征差异而
代表不同统计总体，构成选择偏倚。
```

### 结果部分（结构）
```
1. 数据概览
   - 28个样本，5个数据集
   - X个细胞，Y种细胞类型

2. H1: 组成偏倚
   - 卡方检验: χ² = X, p < 0.001
   - JS散度范围: 0.342-0.587
   - 结论: 存在显著组成差异

3. H2: 状态偏倚
   - 平均R² = X%
   - Y/Z个细胞类型显著（p < 0.05）
   - 结论: 数据集来源解释显著方差

4. H3: 网络偏倚
   - 平均保守性 = X
   - Y个细胞类型显示高偏倚
   - 结论: 网络结构存在系统性差异

5. 差异表达
   - 平均DEGs = X
   - 范围: Y-Z
   - 结论: 对照组间存在显著异质性
```

### 方法部分（关键点）
```
- 质控: 线粒体<20%, 基因数200-6000
- 批次校正: Harmony
- 聚类: Leiden算法
- 注释: 基于marker基因的Z-score和相对特异性
- H1: 卡方检验、JS散度、Kruskal-Wallis
- H2: PCA、PERMANOVA、方差分解
- H3: WGCNA（软阈值、TOM、模块保守性）
- DE: Wilcoxon秩和检验，FDR校正
```

## 🔧 常用参数调整

### config.py
```python
# 质控阈值
QC_PARAMS = {
    'min_genes': 200,        # 最少基因数
    'max_genes': 6000,       # 最多基因数
    'min_counts': 500,       # 最少UMI数
    'max_counts': 50000,     # 最多UMI数
    'max_mito_pct': 20       # 最大线粒体比例
}

# 处理参数
PROCESSING_PARAMS = {
    'n_top_genes': 2000,     # 高变基因数（可减少以节省内存）
    'resolution': 0.5,       # 聚类分辨率
    'min_cluster_size': 50   # 最小cluster大小
}
```

### 内存优化
```python
# 如果内存不足，在各分析函数中减少：
n_hvgs = 500              # 从2000降到500
n_pcs = 30                # 从50降到30
```

## ⚠️ 常见错误处理

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| 内存不足 | 数据量太大 | 减少n_hvgs参数 |
| WGCNA失败 | 细胞数不足 | 检查每个细胞类型≥100细胞 |
| 导入错误 | 缺少依赖包 | `pip install scanpy harmonypy` |
| 路径错误 | 数据路径不对 | 检查config.py中的BASE_DIR |
| 表格乱码 | 编码问题 | Excel打开时选择UTF-8 |

## 📞 检查清单

运行前：
- [ ] 数据文件在 `./GSE159354/` 目录下
- [ ] 已安装所有依赖包
- [ ] config.py 中路径设置正确
- [ ] 至少32GB可用内存

运行后：
- [ ] `results/` 目录已创建
- [ ] 6个 `Table_*.csv` 文件已生成
- [ ] `analysis_report.txt` 已生成
- [ ] `figures/` 目录包含所有图表

论文写作：
- [ ] 已阅读 `analysis_report.txt`
- [ ] 已检查所有表格数据
- [ ] 已选择代表性图表
- [ ] 已参考README中的解读指南

## 🎯 核心文件（10个）

1. `main_analysis.py` - 主流程
2. `config.py` - 配置
3. `utils_data_loading.py` - 数据加载
4. `utils_preprocessing.py` - 预处理
5. `utils_annotation.py` - 注释
6. `utils_hypothesis_testing.py` - H1/H2
7. `utils_wgcna.py` - WGCNA核心
8. `utils_network_analysis_improved.py` - H3/DE
9. `utils_result_tables.py` - 表格生成 ⭐
10. `README_项目说明.md` - 完整文档 ⭐

## 💡 提示

- 首次运行建议使用小数据集测试
- 表格文件可直接用于论文补充材料
- 所有统计方法都是Nature级别标准
- 详细文档见 `README_项目说明.md`

---

**版本**: 2.0
**更新**: 2026-01-21
**状态**: ✅ 生产就绪
