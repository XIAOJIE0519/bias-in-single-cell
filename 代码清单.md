# 代码文件清单

## ✅ 核心文件（必需）

### 主分析脚本
1. **main_analysis.py** (493行)
   - 完整的分析流程
   - 包含数据加载、预处理、注释、H1/H2/H3分析、差异分析
   - 生成所有结果表格和图表
   - **运行命令**: `python main_analysis.py`

2. **run_final.py** 
   - 快速分析脚本（仅H3和差异分析）
   - 适用于已有预处理数据的情况
   - **运行命令**: `python run_final.py`

### 配置文件
3. **config.py**
   - 所有参数配置
   - 数据集信息
   - 质控阈值
   - 输出路径

### 工具模块
4. **utils_data_loading.py**
   - 加载.h5格式数据
   - 加载marker基因
   - 数据合并

5. **utils_preprocessing.py**
   - 质控指标计算
   - 细胞和基因过滤
   - 归一化和标准化
   - Harmony批次校正

6. **utils_annotation.py**
   - Leiden聚类
   - 基于marker基因的细胞类型注释
   - Z-score标准化和相对特异性评分
   - 注释结果可视化

7. **utils_hypothesis_testing.py**
   - H1: 组成偏倚分析（卡方检验、JS散度、Kruskal-Wallis）
   - H2: 状态偏倚分析（PCA、PERMANOVA、方差分解）

8. **utils_wgcna.py**
   - WGCNA核心算法
   - 软阈值计算
   - TOM矩阵计算
   - 模块识别
   - 模块保守性计算

9. **utils_network_analysis_improved.py**
   - H3: 网络偏倚分析（调用WGCNA）
   - Normal-Normal差异表达分析
   - 结果可视化

10. **utils_result_tables.py** ⭐ **新增**
    - 生成H1/H2/H3/DE的整合表格
    - 格式化输出为CSV
    - 添加显著性标记和解释

## 📄 文档文件

11. **README_项目说明.md** ⭐ **新增**
    - 项目概述
    - 使用说明
    - 结果解读指南
    - 论文写作建议

## ❌ 已删除的文件（不再需要）

- ~~IMPROVEMENTS.py~~ - 临时改进脚本
- ~~test_wgcna_new.py~~ - 测试脚本
- ~~verify_wgcna.py~~ - 验证脚本
- ~~final_check.py~~ - 检查脚本
- ~~test_imports.py~~ - 导入测试
- ~~check_setup.py~~ - 环境检查
- ~~count_lines.py~~ - 代码统计
- ~~最终确认.py~~ - 确认脚本

## 📊 输出文件结构

运行 `main_analysis.py` 后会生成：

```
results/
├── figures/                          # 所有图表
│   ├── H1_*.png                     # H1可视化
│   ├── H2_*.png                     # H2可视化
│   ├── H3_*.png                     # H3可视化
│   └── DE_*.png                     # 差异分析可视化
│
├── Table_H1_Overall_Statistics.csv   # H1总体统计 ⭐
├── Table_H1_CellType_Details.csv     # H1细胞类型详细 ⭐
├── Table_H2_State_Bias.csv           # H2状态偏倚 ⭐
├── Table_H3_Network_Bias.csv         # H3网络偏倚 ⭐
├── Table_DE_Overall_Statistics.csv   # DE总体统计 ⭐
├── Table_DE_CellType_Details.csv     # DE细胞类型详细 ⭐
│
├── analysis_report.txt               # 综合报告
├── annotation_details.csv            # 注释详情
├── celltype_statistics.csv           # 细胞类型统计
│
└── 其他详细结果文件...

data/
├── adata_preprocessed.h5ad           # 预处理后数据
└── adata_annotated.h5ad              # 注释后数据
```

## 🎯 核心改进（v2.0）

### 1. 结果表格整合 ⭐
- **之前**: 结果分散在多个CSV文件中，格式不统一
- **现在**: 每个分析（H1/H2/H3/DE）都有1-2个规范的表格
- **优势**: 可直接用于论文补充材料

### 2. 代码清理
- 删除了8个临时测试文件
- 保留了10个核心模块
- 代码结构更清晰

### 3. 文档完善
- 新增详细的README
- 包含使用说明、结果解读、论文写作建议
- 适合Nature级别投稿

### 4. 报告简化
- `analysis_report.txt` 现在是简化版
- 详细数据都在表格文件中
- 避免冗余信息

## 📝 使用建议

### 首次运行
```bash
# 1. 检查配置
编辑 config.py，确认路径正确

# 2. 运行完整分析
python main_analysis.py

# 3. 查看结果
- 打开 results/analysis_report.txt 查看总结
- 打开 results/Table_*.csv 查看详细数据
- 查看 results/figures/ 中的图表
```

### 后续分析
```bash
# 如果只需要重新运行H3和差异分析
python run_final.py
```

### 论文写作
```bash
# 1. 主文引用的数据
- analysis_report.txt 中的关键统计量

# 2. 补充材料
- 所有 Table_*.csv 文件
- 选择代表性的图表

# 3. 方法部分
- 参考 README_项目说明.md 中的方法学说明
```

## 🔢 代码统计

| 文件 | 行数 | 功能 |
|------|------|------|
| main_analysis.py | ~493 | 主流程 |
| utils_preprocessing.py | ~200 | 预处理 |
| utils_annotation.py | ~300 | 注释 |
| utils_hypothesis_testing.py | ~400 | H1/H2 |
| utils_wgcna.py | ~300 | WGCNA核心 |
| utils_network_analysis_improved.py | ~500 | H3/DE |
| utils_result_tables.py | ~350 | 表格生成 ⭐ |
| **总计** | **~2500** | **核心代码** |

## ✨ 主要特点

1. **模块化设计** - 每个功能独立模块，易于维护
2. **Nature标准** - 所有方法都是领域金标准
3. **结果规范** - 表格格式统一，可直接用于发表
4. **文档完善** - 详细的使用说明和解读指南
5. **代码清洁** - 删除了所有临时文件

---

**版本**: 2.0 (整合表格版)
**更新日期**: 2026-01-21
